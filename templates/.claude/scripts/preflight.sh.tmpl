#!/bin/bash
# Preflight checks for CHAOS v2
# Verifies Beads, Git, and gh CLI are available

set -euo pipefail

ERRORS=()
WARNINGS=()

echo "=== CHAOS Preflight ==="
echo ""

# --- Beads (required) ---
echo "Checking Beads..."
if command -v bd &>/dev/null; then
    BD_VERSION=$(bd --version 2>/dev/null | head -1 || echo "unknown")
    echo "OK: beads ($BD_VERSION)"
else
    ERRORS+=("beads (bd) not found - REQUIRED")
    echo "FAIL: beads not found"
    echo "  Install: go install github.com/steveyegge/beads/cmd/bd@latest"
fi

# --- Git (recommended) ---
echo ""
echo "Checking Git..."
if command -v git &>/dev/null; then
    if git rev-parse --git-dir &>/dev/null 2>&1; then
        echo "OK: git (in repo)"
    else
        WARNINGS+=("git available but not in a git repository")
        echo "WARN: git (not in repo)"
    fi
else
    WARNINGS+=("git not found - recommended for version control")
    echo "WARN: git (not found)"
fi

# --- GitHub CLI (recommended for PR workflow) ---
echo ""
echo "Checking GitHub CLI..."
if command -v gh &>/dev/null; then
    GH_VERSION=$(gh --version 2>/dev/null | head -1 || echo "unknown")
    echo "OK: gh ($GH_VERSION)"
    # Check if authenticated
    if gh auth status &>/dev/null 2>&1; then
        echo "OK: gh authenticated"
    else
        WARNINGS+=("gh CLI not authenticated - run 'gh auth login' for PR workflow")
        echo "WARN: gh not authenticated"
    fi
else
    WARNINGS+=("gh CLI not found - needed for /review-feedback and PR workflow")
    echo "WARN: gh not found"
    echo "  Install: https://cli.github.com/"
fi

# --- Learnings file ---
echo ""
echo "Checking learnings..."
if [[ -f ".chaos/learnings.md" ]]; then
    echo "OK: .chaos/learnings.md exists"
else
    echo "INFO: Creating .chaos/learnings.md"
    mkdir -p .chaos/learnings-archive
    cat > .chaos/learnings.md <<'LEARN_EOF'
# Project Learnings

Observations captured by CHAOS sessions. Patterns appearing 3+ times get promoted to `standards/`.

---

<!-- New learnings are appended below. Use /learn after completing tasks. -->
LEARN_EOF
    echo "OK: .chaos/learnings.md created"
fi

# --- Summary ---
echo ""
echo "================================"
if [[ ${#ERRORS[@]} -gt 0 ]]; then
    echo "PREFLIGHT FAILED"
    echo "Errors:"
    for err in "${ERRORS[@]}"; do
        echo "  - $err"
    done
    if [[ ${#WARNINGS[@]} -gt 0 ]]; then
        echo "Warnings:"
        for warn in "${WARNINGS[@]}"; do
            echo "  - $warn"
        done
    fi
    exit 1
else
    if [[ ${#WARNINGS[@]} -gt 0 ]]; then
        echo "PREFLIGHT PASSED (with warnings)"
        echo "Warnings:"
        for warn in "${WARNINGS[@]}"; do
            echo "  - $warn"
        done
    else
        echo "PREFLIGHT PASSED"
    fi
    exit 0
fi
